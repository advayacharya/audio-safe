{% extends "base.html" %}

{% block title %}Welcome - AudioSafe{% endblock %}

{% block content %}
<!-- 1. Load GSAP Animation Engine -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

    /* GLOBAL RESET */
    html, body {
        margin: 0;
        padding: 0;
        background-color: #020617;
        color: white;
        overflow-x: hidden; 
    }

    /* --- LAYOUT --- */
    
    /* 1. The Fixed Background (Matrix) */
    #matrix-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        opacity: 0.7; 
        pointer-events: none; 
    }

    /* 2. The Scroll Container */
    #scroll-track {
        height: 400vh; 
        position: relative;
        z-index: 10;
    }

    /* 3. The "Stage" */
    #stage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20;
        pointer-events: none; 
    }

    /* 4. Navigation Overlay */
    .nav-overlay {
        position: fixed;
        top: 24px;
        right: 24px; /* Less margin on mobile */
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 12px; /* Less gap on mobile */
        pointer-events: auto;
    }

    .nav-text {
        color: #94a3b8;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
    }

    /* --- STORY ELEMENTS --- */

    /* SCENE 1: HERO TITLE */
    .hero-group {
        text-align: center;
        position: absolute;
        opacity: 1;
        transform: translateY(0);
        padding: 0 1rem; /* Prevent text touching edges */
    }
    .hero-title {
        font-family: 'Inter', sans-serif;
        font-weight: 800;
        font-size: 4rem; /* Mobile default */
        letter-spacing: -0.03em;
        margin-bottom: 1rem;
        background: linear-gradient(180deg, #fff 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    @media (min-width: 768px) {
        .hero-title { font-size: 6rem; }
    }

    /* SCENE 2: ENCRYPTION BOX */
    .encrypt-box {
        position: absolute;
        width: 90%; /* Mobile friendly */
        max-width: 400px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 1.5rem; /* Less padding on mobile */
        opacity: 0;
        transform: translateY(50px) scale(0.9);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    @media (min-width: 768px) {
        .encrypt-box { padding: 2rem; }
    }

    .msg-input {
        font-family: 'JetBrains Mono', monospace;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 1rem;
        border-radius: 12px;
        color: #a78bfa;
        font-size: 1rem; /* Smaller for mobile */
    }
    @media (min-width: 768px) {
        .msg-input { font-size: 1.2rem; }
    }

    .encrypt-label {
        font-size: 0.9rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 700;
    }

    /* SCENE 3: AUDIO WAVE & PARTICLES */
    .audio-stage {
        position: absolute;
        width: 100%;
        max-width: 600px;
        height: 150px; /* Mobile height */
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        padding: 0 1rem; /* Safe padding */
    }
    @media (min-width: 768px) {
        .audio-stage { height: 200px; }
    }

    .wave-line {
        width: 100%;
        height: 100%;
        stroke: #4c1d95;
        stroke-width: 2;
        fill: none;
    }
    .binary-particle {
        position: absolute;
        color: #a78bfa;
        font-family: 'JetBrains Mono', monospace;
        font-size: 10px;
        font-weight: bold;
        opacity: 0;
    }

    /* SCENE 4: FINAL CTA */
    .final-cta {
        position: absolute;
        display: flex;
        flex-direction: column; /* Stack on mobile */
        gap: 15px;
        opacity: 0;
        transform: translateY(20px);
        pointer-events: auto; 
        width: 80%;
        max-width: 300px;
    }
    @media (min-width: 768px) {
        .final-cta { flex-direction: row; width: auto; max-width: none; gap: 20px; }
    }
    
    /* SHARED APPLE BUTTON STYLES */
    .apple-btn {
        background: white;
        color: black;
        padding: 1rem 2rem; /* Adjusted */
        border-radius: 100px;
        font-weight: 600;
        font-size: 1.1rem;
        text-decoration: none;
        transition: transform 0.2s;
        box-shadow: 0 0 30px rgba(255,255,255,0.2);
        display: inline-flex;
        align-items: center;
        justify-content: center; /* Center content */
        gap: 8px;
    }
    .apple-btn:hover { transform: scale(1.05); }
    
    .apple-btn.secondary {
        background: rgba(255,255,255,0.1);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        box-shadow: none;
    }

    /* Small variant for Nav */
    .apple-btn.small {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        box-shadow: none;
    }

    /* SCROLL INDICATOR */
    .scroll-hint {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255,255,255,0.3);
        font-size: 0.8rem;
        letter-spacing: 2px;
        animation: bounce 2s infinite;
        z-index: 50;
        width: 100%;
        text-align: center;
    }
    @keyframes bounce {
        0%, 100% { transform: translate(-50%, 0); opacity: 0.3; }
        50% { transform: translate(-50%, 10px); opacity: 1; }
    }

    /* QUICK VIEW OVERRIDES FOR MOBILE */
    body.quick-mode #stage {
        gap: 2rem;
    }
    @media (min-width: 768px) {
        body.quick-mode #stage { gap: 3rem; }
    }
</style>

<!-- 1. Background Matrix Canvas -->
<canvas id="matrix-canvas"></canvas>

<!-- 2. Navigation Overlay (RESTORED) -->
<div class="nav-overlay">
    {% if current_user.is_authenticated %}
        <!-- Vault Button -->
        <a href="{{ url_for('dashboard') }}" class="apple-btn secondary small">
            <i data-lucide="archive" style="width: 14px; height: 14px;"></i> 
            <span class="hidden sm:inline">Vault</span>
        </a>
        
        <!-- User ID -->
        <span class="nav-text hidden md:inline">{{ current_user.email }}</span>
        
        <!-- Logout Button -->
        <a href="{{ url_for('logout') }}" class="apple-btn secondary small" style="border-color: rgba(248, 113, 113, 0.4); color: #fca5a5;">
            Log Out
        </a>
    {% else %}
        <!-- Sign In Button -->
        <a href="{{ url_for('login_page') }}" class="apple-btn small">
            Sign In
        </a>
    {% endif %}
</div>

<!-- 3. The Scroll Trigger Track -->
<div id="scroll-track"></div>

<!-- 4. Fixed Animation Stage -->
<div id="stage">
    
    <!-- SCENE 1: HERO -->
    <div class="hero-group">
        <div class="mb-6 inline-flex p-4 rounded-3xl bg-white/5 border border-white/10 backdrop-blur-xl shadow-2xl">
            <i data-lucide="shield-check" class="w-12 h-12 md:w-16 md:h-16 text-violet-400"></i>
        </div>
        <h1 class="hero-title">AudioSafe</h1>
        <p class="text-lg md:text-xl text-gray-400">The Future of Secure Communication</p>
    </div>

    <!-- SCENE 2: ENCRYPTION -->
    <div class="encrypt-box">
        <div class="encrypt-label">Step 1: Encryption</div>
        <div class="msg-input" id="msg-text">Hello World</div>
        <div class="h-1 w-full bg-gray-700 rounded overflow-hidden">
            <div id="encrypt-bar" class="h-full bg-violet-500 w-0"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 font-mono">
            <span>AES-256</span>
            <span id="lock-status">UNLOCKED</span>
        </div>
    </div>

    <!-- SCENE 3: AUDIO ENCODING -->
    <div class="audio-stage">
        <!-- SVG Waveform -->
        <svg class="wave-line" viewBox="0 0 600 200" preserveAspectRatio="none">
            <path id="waveform-path" d="M0,100 Q150,0 300,100 T600,100" />
        </svg>
        <!-- Container for binary particles -->
        <div id="particle-container"></div>
    </div>

    <!-- SCENE 4: FINAL CTA -->
    <div class="final-cta">
        <a href="/encode" class="apple-btn">Encode</a>
        <a href="/decode" class="apple-btn secondary">Decode</a>
    </div>

</div>

<div class="scroll-hint">SCROLL TO EXPLORE</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        gsap.registerPlugin(ScrollTrigger);

        // --- 1. MATRIX BACKGROUND (Bright & Glowing) ---
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const config = { chars: "01", fontSize: 14, gap: 30 }; 
        
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles = [];
            // Mobile Optimization: More gap for less clutter
            const isMobile = width < 768;
            const gap = isMobile ? 40 : 30;
            
            const cols = Math.ceil(width / gap);
            const rows = Math.ceil(height / gap);
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    if(Math.random() > 0.8) { 
                        particles.push({
                            x: i * gap, y: j * gap,
                            char: Math.random() > 0.5 ? "1" : "0",
                            alpha: Math.random() 
                        });
                    }
                }
            }
        }

        // --- MOBILE TOUCH SUPPORT FOR MATRIX ---
        const mouse = { x: -1000, y: -1000 };
        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });
        window.addEventListener('touchmove', e => {
            const touch = e.touches[0];
            mouse.x = touch.clientX;
            mouse.y = touch.clientY;
        }, { passive: true });

        function animateBg() {
            ctx.clearRect(0, 0, width, height);
            ctx.font = `bold ${config.fontSize}px 'JetBrains Mono'`; 

            particles.forEach(p => {
                p.alpha -= 0.005;
                if(p.alpha <= 0) {
                    p.alpha = 1;
                    p.char = Math.random() > 0.5 ? "1" : "0";
                }
            
                ctx.fillStyle = `rgba(76, 29, 149, ${p.alpha})`; // Dark Violet
                ctx.fillText(p.char, p.x, p.y);
            });
            requestAnimationFrame(animateBg);
        }
        resize();
        window.addEventListener('resize', resize);
        animateBg();


        // --- 2. SCROLLYTELLING TIMELINE ---
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: "#scroll-track",
                start: "top top",
                end: "bottom bottom",
                scrub: 1, 
                pin: false 
            }
        });

        // STEP A: Fade Out Hero
        tl.to(".hero-group", { opacity: 0, scale: 0.8, duration: 2 })
          // Fade In Encryption Box
          .to(".encrypt-box", { opacity: 1, scale: 1, y: 0, duration: 2 }, "-=1");

        // STEP B: Encryption Simulation
        const scrambleObj = { value: 0 };
        const originalText = "Hello World";
        const msgText = document.getElementById('msg-text');
        
        tl.to(scrambleObj, {
            value: 100,
            duration: 3,
            onUpdate: () => {
                const progress = scrambleObj.value / 100;
                if(progress < 0.5) {
                    msgText.innerText = originalText;
                    msgText.style.color = "#a78bfa";
                } else {
                    let display = "";
                    for(let i=0; i<12; i++) display += "0123456789abcdef"[Math.floor(Math.random()*16)];
                    msgText.innerText = display;
                    msgText.style.color = "#ef4444"; 
                }
            }
        }, "encrypt")
        .to("#encrypt-bar", { width: "100%", backgroundColor: "#ef4444", duration: 3 }, "encrypt")
        .to("#lock-status", { text: "LOCKED", color: "#ef4444", duration: 0.1 }, "encrypt+=2.5");

        // STEP C: Box Out, Audio Wave In
        tl.to(".encrypt-box", { opacity: 0, scale: 1.2, filter: "blur(10px)", duration: 2 })
          .to(".audio-stage", { opacity: 1, duration: 2 }, "-=1");

        // STEP D: Wave Animation
        tl.to("#waveform-path", { 
            attr: { d: "M0,100 Q150,50 300,100 T600,100" }, 
            yoyo: true, 
            repeat: 5, 
            duration: 0.5 
        }, "wave");

        // Particles entering wave
        const particleContainer = document.getElementById('particle-container');
        // Reduce particles on mobile for performance
        const particleCount = window.innerWidth < 768 ? 5 : 10;
        const startX = window.innerWidth < 768 ? 20 : 50;

        for(let i=0; i<particleCount; i++) {
            const p = document.createElement('div');
            p.className = 'binary-particle';
            p.innerText = Math.random() > 0.5 ? "1" : "0";
            p.style.top = "-50px"; 
            p.style.left = `${startX + i * 50}px`;
            particleContainer.appendChild(p);
            
            tl.to(p, { 
                top: "100px", 
                opacity: 1, 
                duration: 1, 
                ease: "power2.in" 
            }, `wave+=${i * 0.1}`); 
            
            tl.to(p, { opacity: 0, scale: 0, duration: 0.2 }, ">");
        }

        // Wave turns green
        tl.to(".wave-line", { stroke: "#10b981", strokeWidth: 4, duration: 1 }); 

        // STEP E: Final Buttons
        tl.to(".final-cta", { opacity: 1, y: 0, duration: 2 });
        
        // Pause at end
        tl.to({}, { duration: 2 }); 
    });
</script>
{% endblock %}